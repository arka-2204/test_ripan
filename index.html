<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Happy Rose Day! ðŸŒ¹</title>
  
  <link rel="preload" href="./rose.glb" as="fetch" crossorigin>

  <style>
    body { 
      margin: 0; padding: 0; overflow: hidden; height: 100vh; 
      background: linear-gradient(to bottom, #ffe0e0, #ffb6c1); 
      font-family: Arial, sans-serif; touch-action: none; 
    }
    
    h1 {
      position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
      margin: 0; color: #d10024; font-size: 5rem; font-family: "Brush Script MT", cursive;
      text-shadow: 2px 2px 6px rgba(255,255,255,0.9);
      z-index: 10; pointer-events: none; white-space: nowrap;
      text-align: center; width: 90%;
    }

    /* Loading Screen Styles */
    #loading-screen {
      position: fixed; inset: 0; background: #ffb6c1; 
      z-index: 10000; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 1s ease-out;
    }
    #loading-screen.fade-out { opacity: 0; pointer-events: none; }
    .loading-text { color: #d10024; font-family: "Brush Script MT", cursive; font-size: 3rem; z-index: 10001; }

    canvas { position: fixed; inset: 0; z-index: 1; }
    
    .petal {
      position: absolute; width: 15px; height: 15px; top: -20px;
      border-radius: 150% 0 150% 0; opacity: 0.85; z-index: 2;
      pointer-events: none; box-shadow: 1px 1px 5px rgba(0,0,0,0.1);
    }

    @keyframes fall {
      0% { top: -50px; opacity: 0; transform: translateX(0) rotate(0deg); }
      10% { opacity: 1; }
      100% { top: 110vh; opacity: 0.7; transform: translateX(20px) rotate(360deg); }
    }

    #err {
      position: fixed; left: 16px; bottom: 16px; right: 16px;
      background: rgba(0,0,0,0.75); color: #fff; padding: 12px 14px;
      border-radius: 10px; font-family: monospace; z-index: 9999; 
      display: none; white-space: pre-wrap;
    }

    @media (max-width: 600px) { h1 { font-size: 2.5rem; top: 20px; } .loading-text { font-size: 2rem; } }
  </style>
</head>
<body>

  <div id="loading-screen">
    <div class="loading-text">Picking the perfect rose for my phool...</div>
  </div>

  <h1>Happy Rose Day! ðŸŒ¹</h1>
  <div id="err"></div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
        "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';

    const loadingScreen = document.getElementById("loading-screen");
    const errBox = document.getElementById("err");
    const showErr = (msg) => { errBox.style.display = "block"; errBox.textContent = msg; };

    // 1) Petal Logic (Unified for loading and background)
    function createPetal(container = document.body) {
      const petal = document.createElement("div");
      petal.className = "petal";
      petal.style.left = Math.random() * 100 + "vw";
      const duration = Math.random() * 5 + 3;
      petal.style.animation = `fall ${duration}s linear infinite`;
      const size = Math.random() * 10 + 10;
      petal.style.width = `${size}px`; petal.style.height = `${size}px`;
      const colors = ["#ff0040", "#ff4d4d", "#e60023", "#ff80a0", "#ff9999"];
      petal.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      container.appendChild(petal);
      setTimeout(() => petal.remove(), duration * 1000);
    }

    // Dense petal storm for loading, then regular background petals
    const loadingInterval = setInterval(() => createPetal(loadingScreen), 50);
    setInterval(() => createPetal(), 300);

    // 2) Three.js Setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.2, 3.5);

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 1.5));
    const dir = new THREE.DirectionalLight(0xffffff, 2.0);
    dir.position.set(5, 10, 7);
    scene.add(dir);

    // 3) Loader
    const loader = new GLTFLoader();
    const draco = new DRACOLoader();
    draco.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");
    loader.setDRACOLoader(draco);

    let rose = null;
    loader.load("./rose.glb", (gltf) => {
      rose = gltf.scene;
      const s = window.innerWidth < 600 ? 3.5 : 5.5;
      rose.scale.set(s, s, s);
      rose.position.set(0, 0.4, 0); // Middle position
      scene.add(rose);

      // Hide loading screen when ready
      clearInterval(loadingInterval);
      loadingScreen.classList.add("fade-out");
      setTimeout(() => loadingScreen.remove(), 1000);
    }, undefined, (e) => showErr("Failed to load rose.glb. Ensure the file is in the folder."));

    // 4) Interaction
    const mouse = { x: 0, y: 0 };
    const smooth = { x: 0, y: 0 };

    const updateCoords = (x, y) => {
      mouse.x = (x / window.innerWidth) * 2 - 1;
      mouse.y = -(y / window.innerHeight) * 2 + 1;
    };

    window.addEventListener("mousemove", (e) => updateCoords(e.clientX, e.clientY));
    window.addEventListener("touchmove", (e) => {
      if(e.touches.length > 0) updateCoords(e.touches[0].clientX, e.touches[0].clientY);
    }, { passive: false });

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 5) Animation Loop
    function animate() {
      requestAnimationFrame(animate);
      smooth.x += (mouse.x - smooth.x) * 0.08;
      smooth.y += (mouse.y - smooth.y) * 0.08;

      if (rose) {
        rose.position.x = smooth.x * 0.3;
        rose.position.y = 0.4 + (smooth.y * 0.2);
        rose.rotation.y = smooth.x * 0.8; // Interactive turn
        rose.rotation.x = -smooth.y * 0.3; // Interactive tilt
      }
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
